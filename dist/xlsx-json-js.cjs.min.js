/*!
 * xlsx-json-js v0.1.4
 * (c) 2019-2020 diyao<raojianb@mail2.sysu.edu.cn>
 * Released under the MIT License.
 */
"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e){return function(e){if(Array.isArray(e))return a(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||n(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(e,t){if(e){if("string"==typeof e)return a(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?a(e,t):void 0}}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function o(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=n(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var a=0,o=function(){};return{s:o,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,i=!0,l=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return i=e.done,e},e:function(e){l=!0,s=e},f:function(){try{i||null==r.return||r.return()}finally{if(l)throw s}}}}var s=require("xlsx"),i=function(){function n(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n)}var a,i,l;return a=n,l=[{key:"switch2customStructure",value:function(e){for(var t=0,r=e.length;t<r;t+=1)e[t].data=n.rotateMatrix(e[t].data),e[t].data[0]=n.fillCellMerge(e[t].data[0])}},{key:"rotateMatrix",value:function(e){var t=[],r=[];e.forEach((function(e){r.push(e.length)}));for(var n=0,a=Math.max.apply(null,r);n<a;n+=1){for(var o=[],s=0,i=e.length;s<i;s+=1)o[s]=e[s][n];t.push(o)}return t}},{key:"fillCellMerge",value:function(e){for(var t=0,r=e.length;t<r;t+=1)void 0===e[t]||e[t].trim&&""===e[t].trim()?0===t?(console.warn("The first line of the json-attribute description value is forbidden to be null."),e[t]="firstLineAttrDesc"):e[t]=e[t-1]:e[t]=e[t].toString().replace(/\s/g,"");return e}},{key:"isRequire",value:function(e){return/(.*)\#require\([\'\"]*([^\'\"]+)[\'\"]*\)/gi.exec(e)}}],(i=[{key:"parse",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="string"==typeof e?"readFile":"read",a=s[n](e,t),i=[],l=a.SheetNames;t.entry&&l.includes(t.entry)||(t.entry=l[0]);var u=t.sheets||l;u instanceof Array&&(u.unshift(t.entry),u=r(new Set(u)));var c,f=o(u);try{for(f.s();!(c=f.n()).done;){var h=c.value,v=a.Sheets[h];i.push({sheetName:h,data:s.utils.sheet_to_json(v,{header:1,raw:!0,cellDates:!0})})}}catch(e){f.e(e)}finally{f.f()}for(var y=0,p=i.length;y<p;y+=1)for(var d=i[y].data,m=0;m<d.length;m+=1)0===d[m].length&&(d.splice(m,1),m-=1);if(/\ufffd/.test(JSON.stringify(i)))throw new Error("Exceptional characters are found!");return i}},{key:"parse2json",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.zeroCorrection(),this.parsedXlsxData=this.parse(e,t),n.switch2customStructure(this.parsedXlsxData);var r=this.convertProcess(this.parsedXlsxData[0].data);return r}},{key:"zeroCorrection",value:function(){this.parse2jsonDataCache=[],this.parse2jsonCover=new Set}},{key:"analysisAttrDesc",value:function(e){var t=e.match(/\[(\d+)\]$/);return Array.isArray(t)?[!0,e.split("[")[0],+t[1]]:"[]"===e.slice(-2)?[!0,e.slice(0,-2),null]:[!1,e,null]}},{key:"createJsonEnumCol",value:function(t,r,a,o,s,i){if(""!==r){if("object"!==e(r)&&(r=r.split(".")),0===r.length)return t;var l=r.shift(),u=n.isRequire(l);if(u){l=u[1];var c=this.getParsedXlsxDataIndex(u[2]),f=this.parsedXlsxData[c].data;return f=this.convertProcess(f,c)[o],this.createJsonEnumCol(t,l,f,o,s,c)}var h=this.analysisAttrDesc(l),v=h[0],y=h[1],p=h[2],d=0===r.length;if(v){if(void 0===t[y]?t[y]=[]:Array.isArray(t[y])||(this.collectCoverKey(i,s),t[y]=[]),null===p)t[y].push(d?a||"":{});else if(d&&void 0!==t[y][p]&&this.collectCoverKey(i,s),d)t[y][p]=a||"";else{var m=t[y][p],b="object"===e(m)?m:{};t[y][p]=Object.assign({},b)}var g=p||t[y].length-1;return this.createJsonEnumCol(t[y][g],r,a,o,s,i)}return void 0===t[y]?t[y]=d?a||"":{}:"[object Object]"!==Object.prototype.toString.call(t[y])?(this.collectCoverKey(i,s),t[y]=d?a||"":{}):d&&(this.collectCoverKey(i,s),t[y]=a||""),this.createJsonEnumCol(t[y],r,a,o,s,i)}}},{key:"convertProcess",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=[];if(this.parse2jsonDataCache[t])return this.parse2jsonDataCache[t];for(var n=e[0].concat(),a=1,o=e.length;a<o;a+=1){for(var s=e[a],i={},l=0,u=s.length;l<u;l+=1)this.createJsonEnumCol(i,n[l],s[l],a-1,l,t);r.push(i)}return this.parse2jsonDataCache[t]=r,r}},{key:"getParsedXlsxDataIndex",value:function(e){var t;if("number"==typeof+e&&+e<this.parsedXlsxData.length)return+e;for(var r=0,n=this.parsedXlsxData.length;r<n;r+=1)if(e===this.parsedXlsxData[r].sheetName){t=r;break}if(void 0===t)throw new Error("'required' parameter is not valid: There is no such 'sheet': ".concat(e));return t}},{key:"collectCoverKey",value:function(e,t){var r=this.parsedXlsxData[e].sheetName,n=this.parsedXlsxData[e].data[0][t],a='sheet name "'.concat(r,'", row ').concat(t+1,', value "').concat(n,'"');this.parse2jsonCover.add(a)}}])&&t(a.prototype,i),l&&t(a,l),n}(),l=new i;Object.defineProperties(i,{parse:{value:l.parse.bind(l)},parse2json:{value:l.parse2json.bind(l)},parse2jsonDaTa:{value:l.parse2jsonDaTa},parse2jsonCover:{value:l.parse2jsonCover},parsedXlsxData:{value:l.parsedXlsxData}}),module.exports=i;